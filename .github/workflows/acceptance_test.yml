# this is a generated file, DO NOT EDIT
# to generate this file run make pre-commit
# this is a generated file, DO NOT EDIT
# to generate this file run make pre-commit

name: Acceptance Tests
on:
  schedule:
    - cron: '30 19 * * *'
  workflow_dispatch:

env:
  ACC_TEST_CI: 1

jobs:
  createproject:
    name: Create Project
    runs-on: ubuntu-latest
    outputs:
      projectID: ${{ steps.create_project.outputs.ACC_TEST_PROJECT_ID }}
    steps:
      - name: Create test project
        id: create_project
        shell: bash
        run: |
          # JSON_DATA=$(cat << EOF
          # { 
          # "name": "${{ github.event.repository.name }}_${{ github.run_id }}", 
          # "containerParentId": "${{ secrets.ACC_TEST_PARENT_CONTAINER_ID }}", 
          # "members": [{ 
          # "role": "project.owner", 
          # "subject": "${{ secrets.ACC_TEST_USER_EMAIL }}" 
          # },{ 
          # "role": "project.owner", 
          # "subject": "${{ secrets.STACKIT_SERVICE_ACCOUNT_EMAIL }}" 
          # }], 
          # "labels": { 
          # "billingReference": "${{ secrets.ACC_TEST_BILLING_REF }}", 
          # "scope": "PUBLIC" 
          # }
          # }
          # EOF
          # )
          
          # curl --location --request POST 'https://api.stackit.cloud/resource-management/v2/projects' \
          #   --header 'Content-Type: application/json' \
          #   --header 'Accept: application/json' \
          #   --header 'Authorization: Bearer ${{ secrets.STACKIT_SERVICE_ACCOUNT_TOKEN }}' \
          #   --data-raw "${JSON_DATA}" > $HOME/pr.json
          
          # ACC_TEST_PROJECT_ID="$(jq -r '.projectId' $HOME/pr.json)"
          ACC_TEST_PROJECT_ID="a4d42390-a3fb-40a5-bbab-ecc3988f8091"
          echo "ACC_TEST_PROJECT_ID=${ACC_TEST_PROJECT_ID}" >> $GITHUB_ENV
          echo "ACC_TEST_PROJECT_ID=${ACC_TEST_PROJECT_ID}" >> $GITHUB_OUTPUT
          [[ -z "${ACC_TEST_PROJECT_ID}" || "${ACC_TEST_PROJECT_ID}" == "NULL" || "${ACC_TEST_PROJECT_ID}" == "null" ]] && exit 1 || exit 0

      - name: Wait project created
        id: wait_project_active
        uses: mydea/action-wait-for-api@v1
        with:
          url: 'https://api.stackit.cloud/resource-management/v2/projects/${{ env.ACC_TEST_PROJECT_ID }}'
          headers: '{
              "Accept": "application/json",
              "Authorization": "Bearer ${{ secrets.STACKIT_SERVICE_ACCOUNT_TOKEN }}"
            }'
          expected-response-field: 'lifecycleState'
          expected-response-field-value: 'ACTIVE'


  dsobject-storage:
    strategy:
      max-parallel: 1
      matrix:
        name: [object-storage bucket,object-storage credential,object-storage credentials-group,object-storage project]
        include:

        - name: object-storage bucket
          path: stackit/internal/data-sources/object-storage/bucket

        - name: object-storage credential
          path: stackit/internal/data-sources/object-storage/credential

        - name: object-storage credentials-group
          path: stackit/internal/data-sources/object-storage/credentials-group

        - name: object-storage project
          path: stackit/internal/data-sources/object-storage/project

    name: ${{ matrix.name }}
    needs: createproject
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test ${{ matrix.name }} Data Source
        shell: bash
        run: |
          make dummy PATH=${{ matrix.path }}

  dsargus:
    strategy:
      max-parallel: 1
      matrix:
        name: [argus instance,argus job]
        include:

        - name: argus instance
          path: stackit/internal/data-sources/argus/instance

        - name: argus job
          path: stackit/internal/data-sources/argus/job

    name: ${{ matrix.name }}
    needs: createproject
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test ${{ matrix.name }} Data Source
        shell: bash
        run: |
          make dummy PATH=${{ matrix.path }}

  dsdata-services:
    strategy:
      max-parallel: 1
      matrix:
        name: [data-services credential,data-services instance]
        include:

        - name: data-services credential
          path: stackit/internal/data-sources/data-services/credential

        - name: data-services instance
          path: stackit/internal/data-sources/data-services/instance

    name: ${{ matrix.name }}
    needs: createproject
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test ${{ matrix.name }} Data Source
        shell: bash
        run: |
          make dummy PATH=${{ matrix.path }}

  dskubernetes:
    strategy:
      max-parallel: 1
      matrix:
        name: [kubernetes cluster,kubernetes project]
        include:

        - name: kubernetes cluster
          path: stackit/internal/data-sources/kubernetes/cluster

        - name: kubernetes project
          path: stackit/internal/data-sources/kubernetes/project

    name: ${{ matrix.name }}
    needs: createproject
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test ${{ matrix.name }} Data Source
        shell: bash
        run: |
          make dummy PATH=${{ matrix.path }}

  datasources:
    strategy:
      matrix:
        name: [project,mongodb-flex instance,postgres-flex instance]
        include:

        - name: project
          path: stackit/internal/data-sources/project

        - name: mongodb-flex instance
          path: stackit/internal/data-sources/mongodb-flex/instance

        - name: postgres-flex instance
          path: stackit/internal/data-sources/postgres-flex/instance

    name: ${{ matrix.name }}
    needs: createproject
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test ${{ matrix.name }} Data Source
        shell: bash
        run: |
          make dummy PATH=${{ matrix.path }}



  resargus-instance:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test argus instance Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test argus instance Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/argus/instance

  resargus-job:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex,resargus-instance]
    name: Test argus job Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test argus job Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/argus/job

  resdata-services-credential:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test data-services credential Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test data-services credential Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/data-services/credential

  resdata-services-instance:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex,resdata-services-credential]
    name: Test data-services instance Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test data-services instance Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/data-services/instance

  reskubernetes-cluster:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test kubernetes cluster Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test kubernetes cluster Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/kubernetes/cluster

  reskubernetes-project:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex,reskubernetes-cluster]
    name: Test kubernetes project Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test kubernetes project Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/kubernetes/project

  resmongodb-flex-instance:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test mongodb-flex instance Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test mongodb-flex instance Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/mongodb-flex/instance

  resobject-storage-bucket:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test object-storage bucket Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test object-storage bucket Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/object-storage/bucket

  resobject-storage-credential:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex,resobject-storage-bucket]
    name: Test object-storage credential Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test object-storage credential Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/object-storage/credential

  resobject-storage-credentials-group:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex,resobject-storage-bucket,resobject-storage-credential]
    name: Test object-storage credentials-group Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test object-storage credentials-group Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/object-storage/credentials-group

  resobject-storage-project:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex,resobject-storage-bucket,resobject-storage-credential,resobject-storage-credentials-group]
    name: Test object-storage project Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test object-storage project Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/object-storage/project

  respostgres-flex-instance:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test postgres-flex instance Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test postgres-flex instance Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/postgres-flex/instance

  resproject:
    needs: [object-storage,postgres-flex,project,argus,data-services,kubernetes,mongodb-flex,project,argus,data-services,kubernetes,mongodb-flex,object-storage,postgres-flex]
    name: Test project Resource
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Prepare environment
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      - name: Test project Resource
        shell: bash
        run: |
          make dummy PATH=stackit/internal/resources/project


      # - name: Test
      #   id: acceptance-test
      #   run: make testacc ACC_TEST_BILLING_REF="${{ secrets.ACC_TEST_BILLING_REF }}" ACC_TEST_USER_EMAIL="${{ secrets.ACC_TEST_USER_EMAIL }}" STACKIT_SERVICE_ACCOUNT_TOKEN="${{ secrets.STACKIT_SERVICE_ACCOUNT_TOKEN }}" STACKIT_SERVICE_ACCOUNT_EMAIL="${{ secrets.STACKIT_SERVICE_ACCOUNT_EMAIL }}"

  deleteproject:
    name: Delete Project
    runs-on: ubuntu-latest
    needs: [resargus-instance,resargus-job,resdata-services-credential,resdata-services-instance,reskubernetes-cluster,reskubernetes-project,resmongodb-flex-instance,resobject-storage-bucket,resobject-storage-credential,resobject-storage-credentials-group,resobject-storage-project,respostgres-flex-instance,resproject]
    if: ${{ always() }}
    steps:
      - name: Prepare deletion
        id: prep_deletion
        if: always()
        shell: bash
        run: |
          echo "ACC_TEST_PROJECT_ID=${{needs.createproject.outputs.projectID}}" >> $GITHUB_ENV
      # - name: Delete test project
      #   id: delete_project
      #   if: always()
      #   shell: bash
      #   run:   |
      #     [[ -z "${ACC_TEST_PROJECT_ID}" || "${ACC_TEST_PROJECT_ID}" == "NULL" || "${ACC_TEST_PROJECT_ID}" == "null" ]] && exit 0
      #     echo "Deleting project ID: ${ACC_TEST_PROJECT_ID}"
      #     curl --location --request DELETE 'https://api.stackit.cloud/resource-management/v2/projects/${{ env.ACC_TEST_PROJECT_ID }}' \
      #       --header 'Accept: application/json' \
      #       --header 'Authorization: Bearer ${{ secrets.STACKIT_SERVICE_ACCOUNT_TOKEN }}'
